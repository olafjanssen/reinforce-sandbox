<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sandbox for Waterworld with REINFORCEjs</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jquery and jqueryui -->
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <link href="external/jquery-ui.min.css" rel="stylesheet">
    <script src="external/jquery-ui.min.js"></script>

    <!-- bootstrap -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

    <!-- d3js -->
    <script type="text/javascript" src="external/d3.min.js"></script>

    <!-- rljs -->
    <script type="text/javascript" src="lib/rl.js"></script>

    <!-- flotjs -->
    <script src="external/jquery.flot.min.js"></script>

    <!-- environment dynamics -->
    <script src="js/Vec.js"></script>
    <script src="js/Item.js"></script>
    <script src="js/Wall.js"></script>
    <script src="js/Eye.js"></script>
    <script src="js/Agent.js"></script>
    <script src="js/World.js"></script>

    <style>
        #wrap {
            width:800px;
            margin-left: auto;
            margin-right: auto;
        }
        h2 {
            text-align: center;
        }
        body {
            font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
        }
        canvas {
            border: 1px solid black;
        }
    </style>

    <script type="application/javascript">
        var canvas, ctx;
        var agentView = false;
        var humanControls = false;

        // Draw everything
        function draw() {
            w.draw(ctx);
        }

        // Tick the world
        var smooth_reward_history = []; // [][];
        var smooth_reward = [];
        var flott = 0;
        function tick() {

            if(simspeed === 3) {
                for(var k=0;k<50;k++) {
                    w.update();
                }
            } else {
                w.update();
            }
            draw();
            updateStats();

            flott += 1;
            for(i=0; i<w.agents.length; i++) {
                var rew = w.agents[i].last_reward;
                if(!smooth_reward[i]) { smooth_reward[i] = 0; }
                smooth_reward[i] = smooth_reward[i] * 0.999 + rew * 0.001;
                if(flott === 50) {
                    // record smooth reward
                    if(smooth_reward_history[i].length >= nflot) {
                        smooth_reward_history[i] = smooth_reward_history[i].slice(1);
                    }
                    smooth_reward_history[i].push(smooth_reward[i]);
                }
            }
            if(flott === 50) {
                flott = 0;
            }

            var agent = w.agents[0];
            if(typeof agent.expi !== 'undefined') {
                $("#expi").html(agent.expi);
            }
            if(typeof agent.tderror !== 'undefined') {
                $("#tde").html(agent.tderror.toFixed(3));
            }
        }

        // flot stuff
        var nflot = 1000;
        function initFlot() {
            var container = $("#flotreward");
            var res = getFlotRewards(0);
            var res1 = getFlotRewards(1);
            series = [{
                data: res,
                lines: {fill: true}
            }, {
                data: res1,
                lines: {fill: true}
            }];
            var plot = $.plot(container, series, {
                grid: {
                    borderWidth: 1,
                    minBorderMargin: 20,
                    labelMargin: 10,
                    backgroundColor: {
                        colors: ["#FFF", "#e4f4f4"]
                    },
                    margin: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                    }
                },
                xaxis: {
                    min: 0,
                    max: nflot
                },
                yaxis: {
                    min: -0.1,
                    max: 0.1
                }
            });
            setInterval(function(){
                for(var i=0; i<w.agents.length; i++) {
                    series[i].data = getFlotRewards(i);
                }
                plot.setData(series);
                plot.draw();
            }, 100);
        }
        function getFlotRewards(agentId) {
            // zip rewards into flot data
            var res = [];
            if(agentId >= w.agents.length || !smooth_reward_history[agentId]) {
                return res;
            }
            for(var i=0,n=smooth_reward_history[agentId].length;i<n;i++) {
                res.push([i, smooth_reward_history[agentId][i]]);
            }
            return res;
        }

        var simspeed = 2;
        function goveryfast() {
            window.clearInterval(current_interval_id);
            current_interval_id = setInterval(tick, 0);
            skipdraw = true;
            simspeed = 3;
        }
        function gofast() {
            window.clearInterval(current_interval_id);
            current_interval_id = setInterval(tick, 0);
            skipdraw = true;
            simspeed = 2;
        }
        function gonormal() {
            window.clearInterval(current_interval_id);
            current_interval_id = setInterval(tick, 30);
            skipdraw = false;
            simspeed = 1;
        }
        function goslow() {
            window.clearInterval(current_interval_id);
            current_interval_id = setInterval(tick, 200);
            skipdraw = false;
            simspeed = 0;
        }

        function saveAgent() {
            var brain = w.agents[0].brain;
            $("#mysterybox").fadeIn();
            $("#mysterybox").val(JSON.stringify(brain.toJSON()));
        }

        function resetAgent() {
            eval($("#agentspec").val())
            var brain = new RL.DQNAgent(env, spec);
            w.agents[0].brain = brain;
        }

        function loadAgent() {
            $.getJSON( "agentzoo/wateragent.json", function( data ) {
                var agent = w.agents[0].brain;
                agent.fromJSON(data); // corss your fingers...
                // set epsilon to be much lower for more optimal behavior
                agent.epsilon = 0.05;
                $("#slider").slider('value', agent.epsilon);
                $("#eps").html(agent.epsilon.toFixed(2));
                // kill learning rate to not learn
                agent.alpha = 0;
            });
        }

        function toggleAgentView() {
            agentView = !agentView;
        }

        var lastKey = null;
        document.onkeydown = function(e) {
            var event = window.event ? window.event : e;
            lastKey = event.keyCode
            if(lastKey == 37 || lastKey == 38 || lastKey == 39 || lastKey == 40) {
                enableHuman();
                e.preventDefault();
                if(lastKey == 37) {
                    humanAction = 0;
                }
                if(lastKey == 39) {
                    humanAction = 1;
                }
                if(lastKey == 38) {
                    humanAction = 2;
                }
                if(lastKey == 40) {
                    humanAction = 3;
                }
            }
        };

        var humanAction = -1;
        function enableHuman() {
            if(!humanControls) {
                humanControls = true;
                var a = new Agent();
                a.forward = function() {
                    this.action = humanAction;
                    humanAction = -1;
                };
                a.brain = {
                    learn: function(reward) {
                        // Do nothing;
                    }
                };
                w.agents.push(a);
                smooth_reward_history.push([]);
            }
        }

        var w; // global world object
        var current_interval_id;
        var skipdraw = false;
        function start() {
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");

            eval($("#agentspec").val())

            w = new World();
            w.agents = [];
            for(var k = 0; k < 1; k++) {
                var a = new Agent();
                env = a;
                a.brain = new RL.DQNAgent(env, spec); // give agent a TD brain
                //a.brain = new RL.RecurrentReinforceAgent(env, {});
                w.agents.push(a);
                smooth_reward_history.push([]);
            }

            $( "#slider" ).slider({
                min: 0,
                max: 1,
                value: w.agents[0].brain.epsilon,
                step: 0.01,
                slide: function(event, ui) {
                    w.agents[0].brain.epsilon = ui.value;
                    $("#eps").html(ui.value.toFixed(2));
                }
            });
            $("#eps").html(w.agents[0].brain.epsilon.toFixed(2));
            $("#slider").slider('value', w.agents[0].brain.epsilon);

            initFlot();
            gonormal();

            // render markdown
            $(".md").each(function(){
                $(this).html(marked($(this).html()));
            });
            renderJax();
        }

        var jaxrendered = false;
        function renderJax() {
            if(jaxrendered) { return; }
            (function () {
                var script = document.createElement("script");
                script.type = "text/javascript";
                script.src  = "http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
                document.getElementsByTagName("head")[0].appendChild(script);
                jaxrendered = true;
            })();
        }

        function updateStats() {
            var stats = "<ul>";
            for(var i=0; i<w.agents.length; i++) {
                stats += "<li>Player " + (i+1) + ": " + w.agents[i].apples + " apples, " + w.agents[i].poison + " poison</li>";
            }
            stats += "</ul>";
            $("#apples_and_poison").html(stats);
        }
    </script>
    <!--<style type="text/css">-->
    <!--canvas { border: 1px solid white; }-->
    <!--</style>-->

</head>
<body onload="start();">

<div id="wrap">

<textarea id="agentspec" style="width:100%;height:250px;">
// agent parameter spec to play with (this gets eval()'d on Agent reset)
var spec = {}
spec.update = 'qlearn'; // qlearn | sarsa
spec.gamma = 0.9; // discount factor, [0, 1)
spec.epsilon = 0.2; // initial epsilon for epsilon-greedy policy, [0, 1)
spec.alpha = 0.005; // value function learning rate
spec.experience_add_every = 5; // number of time steps before we add another experience to replay memory
spec.experience_size = 10000; // size of experience
spec.learning_steps_per_iteration = 5;
spec.tderror_clamp = 1.0; // for robustness
spec.num_hidden_units = 100 // number of neurons in hidden layer
</textarea>

    <div style="text-align:center;">
        <button class="btn btn-danger" onclick="resetAgent()" style="width:150px;height:50px;margin-bottom:5px;">Reinit agent</button>
        <button class="btn btn-success" onclick="goveryfast()" style="width:150px;height:50px;margin-bottom:5px;">Go very fast</button>
        <button class="btn btn-success" onclick="gofast()" style="width:150px;height:50px;margin-bottom:5px;">Go fast</button>
        <button class="btn btn-success" onclick="gonormal()" style="width:150px;height:50px;margin-bottom:5px;">Go normal</button>
        <button class="btn btn-success" onclick="goslow()" style="width:150px;height:50px;margin-bottom:5px;">Go slow</button>
        <button class="btn btn-danger" onclick="toggleAgentView()" style="width:150px;height:50px;margin-bottom:5px;">Toggle Agent View</button>
        <button class="btn btn-danger" onclick="enableHuman()" style="width:150px;height:50px;margin-bottom:5px;">Start playing (use arrow keys)</button>

        <canvas id="canvas" width="700" height="500"></canvas>
    </div>

    <div id="apples_and_poison"></div>

    <div id="brain_info_div"></div>

    <button class="btn btn-primary" onclick="loadAgent()" style="width:200px;height:35px;margin-bottom:5px;margin-right:20px;">Load a Pretrained Agent</button>

    <br>
    Exploration epsilon: <span id="eps">0.15</span> <div id="slider"></div>

    <br>

    <div id="expi"></div>
    <div id="tde"></div>

    <div id="flotreward" style="width:800px; height: 400px;"></div>

    <textarea id="mysterybox" style="width:100%;display:none;">mystery text box</textarea>

</div>
</body>
</html>
